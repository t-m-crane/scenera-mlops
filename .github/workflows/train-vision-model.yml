name: train vision model

on:
  workflow_dispatch:
    inputs:
      datasetName: 
        description: 'Name of dataset in Azure Custom Vision'     
        required: true
        default: 'sample_data'
        type: string
      computerVisionResourceName: 
        description: 'Name of the Computer Vision resource in Azure'     
        required: true
        default: 'cv-teresacrane-demo'
        type: string
jobs:
  train-vision-model:
    runs-on: ubuntu-latest
    outputs:
      model_name: ${{ steps.generate_model_name.outputs.modelName }}
    steps:
      - name: generate model name
        id: generate_model_name
        run: |
          echo "modelName=$(uuidgen)" >> "$GITHUB_OUTPUT"
      
      - name: checkout repo content
        uses: actions/checkout@v2 # checkout the repository content

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # install the python version needed

      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: train vision model
        env:
          RESOURCE_KEY: ${{secrets.RESOURCE_KEY}} 
          MODEL_NAME: ${{ steps.generate_model_name.outputs.modelName }}
          INPUT_DATASET_NAME: ${{ github.event.inputs.datasetName }} 
          INPUT_RESOURCE_NAME: ${{ github.event.inputs.computerVisionResourceName }}
        run: |
          python data-science/src/train/train.py

  log_model_metrics:
    needs: train-vision-model
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo content
        uses: actions/checkout@v2

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 
      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: get training model status
        env:
          RESOURCE_KEY: ${{secrets.RESOURCE_KEY}}
          MODEL_NAME: ${{ needs.train-vision-model.outputs.modelName }}
          INPUT_DATASET_NAME: ${{ github.event.inputs.datasetName }} 
          INPUT_RESOURCE_NAME: ${{ github.event.inputs.computerVisionResourceName }}  
        run: |
          python data-science/src/train/track.py
